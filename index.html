<!doctype html>
<html lang="zh-Hans">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI 学习任务指挥台 · Echo CommandCore</title>
    <link rel="stylesheet" href="styles/main.css" />
  </head>

  <body>
    <a class="skip-link" href="#main-content">跳到主要内容</a>

    <header class="topbar" role="banner">
      <div class="topbar__left">
        <div class="brand" aria-label="应用名称">
          <div class="brand__logo" aria-hidden="true">◉</div>
          <div class="brand__text">
            <div class="brand__title">AI 学习任务指挥台</div>
            <div class="brand__sub">Echo CommandCore</div>
          </div>
        </div>
      </div>

      <form class="topbar__center" role="search" autocomplete="off">
        <label class="sr-only" for="globalSearch">搜索任务</label>
        <input
          id="globalSearch"
          class="input"
          type="search"
          placeholder="搜索任务 / 建议（按 / 聚焦）"
          autocomplete="off"
        />
      </form>

      <div class="topbar__right">
        <div class="progress" aria-label="整体进度">
          <svg class="progress__ring" viewBox="0 0 36 36" aria-hidden="true">
            <path
              class="progress__bg"
              d="M18 2.0845
               a 15.9155 15.9155 0 0 1 0 31.831
               a 15.9155 15.9155 0 0 1 0 -31.831"
            />
            <path
              class="progress__fg"
              id="progressRing"
              stroke-dasharray="0, 100"
              d="M18 2.0845
               a 15.9155 15.9155 0 0 1 0 31.831
               a 15.9155 15.9155 0 0 1 0 -31.831"
            />
          </svg>
          <div class="progress__text" id="progressText">0/0</div>
        </div>

        <button
          id="themeToggle"
          class="btn btn--ghost"
          type="button"
          aria-pressed="false"
        >
          主题
        </button>

        <div class="btn-group" role="group" aria-label="导入导出">
          <button id="btnExportJson" class="btn" type="button">
            导出 JSON
          </button>
          <button id="btnExportMd" class="btn" type="button">导出 MD</button>

          <button id="btnImport" class="btn btn--ghost" type="button">
            导入
          </button>
          <input id="fileImport" type="file" accept="application/json" hidden />
        </div>
      </div>
    </header>

    <div class="app" role="presentation">
      <nav class="sidebar" aria-label="主导航">
        <div class="sidebar__section">
          <div class="sidebar__title">视图</div>
          <div class="seg" role="tablist" aria-label="任务视图切换">
            <button
              class="seg__btn is-active"
              data-filter-status="all"
              type="button"
              role="tab"
              aria-selected="true"
            >
              全部
            </button>
            <button
              class="seg__btn"
              data-filter-status="todo"
              type="button"
              role="tab"
              aria-selected="false"
            >
              待办
            </button>
            <button
              class="seg__btn"
              data-filter-status="doing"
              type="button"
              role="tab"
              aria-selected="false"
            >
              进行中
            </button>
            <button
              class="seg__btn"
              data-filter-status="done"
              type="button"
              role="tab"
              aria-selected="false"
            >
              已完成
            </button>
          </div>
        </div>

        <div class="sidebar__section">
          <div class="sidebar__title">优先级</div>
          <div class="seg" role="tablist" aria-label="优先级过滤">
            <button
              class="seg__btn is-active"
              data-filter-priority="all"
              type="button"
              role="tab"
              aria-selected="true"
            >
              全部
            </button>
            <button
              class="seg__btn"
              data-filter-priority="high"
              type="button"
              role="tab"
              aria-selected="false"
            >
              高
            </button>
            <button
              class="seg__btn"
              data-filter-priority="medium"
              type="button"
              role="tab"
              aria-selected="false"
            >
              中
            </button>
            <button
              class="seg__btn"
              data-filter-priority="low"
              type="button"
              role="tab"
              aria-selected="false"
            >
              低
            </button>
          </div>
        </div>

        <div class="sidebar__section">
          <button
            id="btnFocusMode"
            class="btn btn--primary w-full"
            type="button"
          >
            执行模式
          </button>
          <div class="hint">提示：Esc 退出执行模式</div>
        </div>
      </nav>

      <main id="main-content" class="main" role="main">
        <div class="main__header">
          <h1 class="h1">任务流</h1>
          <button id="btnNewTask" class="btn btn--primary" type="button">
            新建任务
          </button>
        </div>

        <section aria-label="任务列表">
          <ul id="taskList" class="task-list"></ul>
          <div id="emptyTasks" class="empty">
            暂无学习任务，点击「新建任务」开启规划吧～
          </div>
        </section>
      </main>

      <aside class="panel" role="complementary" aria-label="AI 建议与笔记">
        <div class="panel__header">
          <h2 class="h2">AI 建议</h2>
          <div class="sub">把不同 AI 的输出贴进来，归档到任务。</div>
        </div>

        <form id="noteForm" class="card" autocomplete="off">
          <!-- ✅ 来源行：加“管理”按钮 -->
          <div class="label-row">
            <label class="label" for="noteSource" style="margin: 0">来源</label>
            <button
              id="btnManageSources"
              class="btn btn--ghost btn--xs"
              type="button"
            >
              管理
            </button>
          </div>

          <select id="noteSource" class="input">
            <option value="ChatGPT">ChatGPT</option>
            <option value="DeepSeek">DeepSeek</option>
            <option value="Grok">Grok</option>
            <option value="Gemini">Gemini</option>
            <option value="豆包">豆包</option>
            <option value="__custom__">自定义…</option>
          </select>

          <div id="customSourceWrap" hidden>
            <label class="label" for="noteSourceCustom">自定义来源</label>
            <input
              id="noteSourceCustom"
              class="input"
              type="text"
              placeholder="例如：Claude / Kimi / 书本 / 老师"
            />
          </div>

          <label class="label" for="noteTask">归档到任务</label>
          <select id="noteTask" class="input">
            <option value="">未归档</option>
          </select>

          <label class="label" for="noteContent">内容</label>
          <textarea
            id="noteContent"
            class="input textarea"
            rows="6"
            placeholder="粘贴 AI 建议或你的笔记…"
          ></textarea>

          <div class="row">
            <button class="btn btn--primary" type="submit">保存建议</button>
            <button id="btnClearNote" class="btn btn--ghost" type="button">
              清空
            </button>
          </div>

          <div class="hint" aria-live="polite" id="noteLive"></div>
        </form>

        <div class="panel__section">
          <div class="panel__title">最近建议</div>
          <ul id="noteList" class="note-list" aria-live="polite"></ul>
          <div id="emptyNotes" class="empty">
            暂无建议。把你从各个 AI 拿到的输出贴进来吧。
          </div>
        </div>
      </aside>
    </div>

    <!-- Modal: 执行模式 -->
    <div
      id="focusModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="focusTitle"
      hidden
    >
      <div class="modal__mask" data-close="true"></div>
      <div class="modal__panel" role="document">
        <div class="modal__header">
          <h2 id="focusTitle" class="h2">执行模式</h2>
          <button
            id="btnCloseFocus"
            class="btn btn--ghost"
            type="button"
            aria-label="关闭执行模式"
          >
            关闭
          </button>
        </div>

        <div class="modal__body">
          <div id="focusTaskMeta" class="focus-meta"></div>

          <label class="label" for="focusNext"
            >下一步（写下来就更容易做完）</label
          >
          <textarea
            id="focusNext"
            class="input textarea"
            rows="5"
            placeholder="例如：把任务拆成 3 个子步骤…"
          ></textarea>

          <div class="row">
            <button id="btnSaveNext" class="btn btn--primary" type="button">
              保存到任务描述
            </button>
            <button id="btnMarkDoneInFocus" class="btn" type="button">
              标记完成
            </button>
          </div>
        </div>

        <div class="modal__footer hint">
          Tab 键不会离开此窗口；按 Esc 退出，并回到你刚才的位置。
        </div>
      </div>
    </div>

    <!-- Modal: 新建/编辑任务 -->
    <div
      id="taskModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="taskModalTitle"
      hidden
    >
      <div class="modal__mask" data-close="true"></div>

      <div class="modal__panel modal__panel--sm" role="document">
        <div class="modal__header">
          <h2 id="taskModalTitle" class="h2">新建任务</h2>
          <button
            id="btnCloseTaskModal"
            class="btn btn--ghost"
            type="button"
            aria-label="关闭任务弹窗"
          >
            关闭
          </button>
        </div>

        <form id="taskForm" class="modal__body">
          <input type="hidden" id="taskId" value="" />

          <label class="label" for="taskTitle">任务标题（必填）</label>
          <input
            id="taskTitle"
            class="input"
            type="text"
            placeholder="例如：做首页布局"
          />

          <label class="label" for="taskDesc">任务描述</label>
          <textarea
            id="taskDesc"
            class="input textarea"
            rows="5"
            placeholder="写清楚要做什么，越具体越容易完成"
          ></textarea>

          <div class="grid-2">
            <div>
              <label class="label" for="taskPriority">优先级</label>
              <select id="taskPriority" class="input">
                <option value="high">高</option>
                <option value="medium" selected>中</option>
                <option value="low">低</option>
              </select>
            </div>

            <div>
              <label class="label" for="taskEstimate">预估分钟</label>
              <input
                id="taskEstimate"
                class="input"
                type="number"
                min="0"
                step="5"
                value="30"
              />
            </div>
          </div>

          <div class="row">
            <button class="btn btn--primary" type="submit">保存</button>
            <button
              id="btnCancelTaskModal"
              class="btn btn--ghost"
              type="button"
            >
              取消
            </button>
          </div>

          <div class="hint" aria-live="polite" id="taskFormLive"></div>
        </form>
      </div>
    </div>

    <!-- Modal: 通用确认框 -->
    <div
      id="confirmModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="confirmTitle"
      hidden
    >
      <div class="modal__mask" data-close="true"></div>

      <div class="modal__panel modal__panel--xs" role="document">
        <div class="modal__header">
          <h2 id="confirmTitle" class="h2">确认操作</h2>
          <button
            id="btnCloseConfirm"
            class="btn btn--ghost"
            type="button"
            aria-label="关闭确认框"
          >
            关闭
          </button>
        </div>

        <div class="modal__body">
          <div
            id="confirmMessage"
            style="color: var(--muted); white-space: pre-wrap"
          ></div>

          <div class="row" style="justify-content: flex-end">
            <button id="btnConfirmCancel" class="btn btn--ghost" type="button">
              取消
            </button>
            <button id="btnConfirmOk" class="btn btn--danger" type="button">
              确定
            </button>
          </div>

          <div class="hint">提示：Esc 取消，Enter 确定</div>
        </div>
      </div>
    </div>

    <!-- ✅ Modal: 管理自定义来源 -->
    <div
      id="sourcesModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="sourcesTitle"
      hidden
    >
      <div class="modal__mask" data-close="true"></div>

      <div class="modal__panel modal__panel--xs" role="document">
        <div class="modal__header">
          <h2 id="sourcesTitle" class="h2">管理自定义来源</h2>
          <button
            id="btnCloseSources"
            class="btn btn--ghost"
            type="button"
            aria-label="关闭来源管理"
          >
            关闭
          </button>
        </div>

        <div class="modal__body">
          <div class="hint" style="margin-top: 0">
            提示：这里仅管理你添加过的“自定义来源”。
          </div>

          <ul id="sourcesList" class="sources-list"></ul>
          <div id="sourcesEmpty" class="empty">暂无自定义来源</div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div
      id="toast"
      class="toast"
      role="status"
      aria-live="polite"
      aria-atomic="true"
    ></div>

    <script type="module" src="scripts/app.js"></script>
  </body>
</html>
